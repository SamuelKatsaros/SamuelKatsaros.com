---
import type { GetStaticPaths, InferGetStaticPropsType } from 'astro'
import { getCollection, render } from 'astro:content'
import readingTime from 'reading-time'
import type { BreadcrumbList, WithContext } from 'schema-dts'

import ContentWrapper from '@/components/ContentWrapper.astro'
import ProjectLayout from '@/layouts/ProjectLayout'
import client from '@/lib/client'
import { getProjectSchema } from '@/lib/structuredData'

interface Props extends InferGetStaticPropsType<typeof getStaticPaths> {}

export const getStaticPaths = (async () => {
  const projectEntries = await getCollection('projects')
  return projectEntries.map((entry) => ({
    params: { id: entry.id },
    props: { entry }
  }))
}) satisfies GetStaticPaths

const { entry } = Astro.props
const { Content } = await render(entry)

const getLastUpdatedTime = client.api.github['last-updated-file']
const { latestCommitUrl, lastUpdatedTime } = await getLastUpdatedTime
  .$get({ query: { path: `projects/${entry.id}.mdx` } })
  .then(async (res) => {
    if (!res.ok) {
      console.error('GitHub API request failed:', res.status)
      return {
        latestCommitUrl: '',
        lastUpdatedTime: new Date().toISOString()
      }
    }
    return {
      latestCommitUrl: '',
      lastUpdatedTime: new Date().toISOString()
    }
  })
  .catch((error) => {
    console.error('Failed to fetch from GitHub API:', error)
    return {
      latestCommitUrl: '',
      lastUpdatedTime: new Date().toISOString()
    }
  })

const stats = readingTime(entry.body || '')

const breadcrumbSchema: WithContext<BreadcrumbList> = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Projects',
      item: `${import.meta.env.SITE}/projects/`
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: entry.data.title,
      item: `${import.meta.env.SITE}/projects/${entry.id}/`
    }
  ]
}

---

<ProjectLayout
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.heroImage}
  lastUpdatedTime={lastUpdatedTime}
  latestCommitUrl={latestCommitUrl}
  readingTime={Math.ceil(stats.minutes)}
  schema={breadcrumbSchema}
>
  <ContentWrapper content={entry.body || ''}>
    <Content />
  </ContentWrapper>
</ProjectLayout>