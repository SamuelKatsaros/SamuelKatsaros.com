---
import type { GetStaticPaths } from 'astro'
import { getCollection, render } from 'astro:content'

import ContentWrapper from '@/components/ContentWrapper.astro'
import ProjectLayout from '@/layouts/ProjectLayout'
import client from '@/lib/client'

export const getStaticPaths = (async () => {
  const projectEntries = await getCollection('projects')
  return projectEntries.map((entry) => ({
    params: { id: entry.id },
    props: { entry }
  }))
}) satisfies GetStaticPaths

const { entry } = Astro.props
const { Content, headings } = await render(entry)

const getLastUpdatedTime = client.api.github['last-updated-file']
const { latestCommitUrl, lastUpdatedTime } = await getLastUpdatedTime
  .$get({ query: { path: `projects/${entry.id}.mdx` } })
  .then(async (res) => {
    if (!res.ok) {
      return {
        latestCommitUrl: '',
        lastUpdatedTime: new Date().toISOString()
      }
    }
    return res
  })
  .catch(() => ({
    latestCommitUrl: '',
    lastUpdatedTime: new Date().toISOString()
  }))

---

<ProjectLayout
  {...entry.data}
  slug={entry.id}
  headings={headings}
  updatedDate={new Date(lastUpdatedTime)}
  latestCommitUrl={latestCommitUrl}
>
  <Content />
</ProjectLayout>